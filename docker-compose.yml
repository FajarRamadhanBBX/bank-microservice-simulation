services:
  # === Databases ===
  auth-postgres:
    image: postgres:17
    container_name: auth_db
    environment:
      POSTGRES_USER: ${AUTH_USER}
      POSTGRES_PASSWORD: ${AUTH_PASSWORD}
      POSTGRES_DB: ${AUTH_DB}
    volumes:
      - auth-data:/var/lib/postgresql/data
    ports:
      - "5431:5432"

  user-postgres:
    image: postgres:17
    container_name: user_db
    environment:
      POSTGRES_USER: ${USERS_USER}
      POSTGRES_PASSWORD: ${USERS_PASSWORD}
      POSTGRES_DB: ${USERS_DB}
    volumes:
      - user-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  account-postgres:
    image: postgres:17
    container_name: account_db
    environment:
      POSTGRES_USER: ${ACCOUNT_USER}
      POSTGRES_PASSWORD: ${ACCOUNT_PASSWORD}
      POSTGRES_DB: ${ACCOUNT_DB}
    volumes:
      - account-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  # === Microservices ===
  auth-service:
    build: ./auth-service
    container_name: auth-service
    environment:
      - APP_PORT=4001
      - DB_HOST=auth-postgres
      - DB_PORT=5432
      - DB_USER=${AUTH_USER}
      - DB_PASSWORD=${AUTH_PASSWORD}
      - DB_NAME=${AUTH_DB}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
    ports:
      - "4001:4001"
    depends_on:
      - auth-postgres

  user-service:
    build: ./user-service
    container_name: user-service
    environment:
      - APP_PORT=4002
      - DB_HOST=user-postgres
      - DB_PORT=5432
      - DB_USER=${USERS_USER}
      - DB_PASSWORD=${USERS_PASSWORD}
      - DB_NAME=${USERS_DB}
    ports:
      - "4002:4002"
    depends_on:
      - user-postgres

  account-service:
    build: ./account-service
    container_name: account-service
    environment:
      - APP_PORT=4003
      - DB_HOST=account-postgres
      - DB_PORT=5432
      - DB_USER=${ACCOUNT_USER}
      - DB_PASSWORD=${ACCOUNT_PASSWORD}
      - DB_NAME=${ACCOUNT_DB}
      - INTERNAL_SERVICE_SECRET=${INTERNAL_SERVICE_SECRET}
    ports:
      - "4003:4003"
    depends_on:
      - account-postgres

  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    environment:
      - APP_PORT=4000
      # call for services
      - AUTH_SERVICE=http://auth-service:4001
      - USER_SERVICE=http://user-service:4002
      - ACCOUNT_SERVICE=http://account-service:4003
      # - TRANSACTION_SERVICE=http://transaction-service:4004
      - JWT_SECRET=123c88d681442f3b92f4e7a94b4daa8bea2b2bd5fcb1a8ed3bbbd8dd808ddb46
      - INTERNAL_SERVICE_SECRET=123c88d681442f3b92f4e7a94b4daa8bea2b2bd5fcb1a8ed3bbbd8dd8iieqwh
    ports:
      - "4000:4000" 
    depends_on:
      - auth-service
      - user-service
      - account-service

  # === Observability ===
  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    container_name: grafana
    ports:
      - "3000:3000"
    depends_on:
      - prometheus

volumes:
  auth-data:
  user-data:
  account-data: